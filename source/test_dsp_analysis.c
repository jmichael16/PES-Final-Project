/* -----------------------------------------------------------------------------
 * test_dsp_analysis.c - Tests dsp_analysis module 
 *
 * @author  Jake Michael
 * @date    2020-12-07 
 * @rev     1.3
 * -----------------------------------------------------------------------------
 */

#include <stdio.h>
#include <stdint.h>
#include <assert.h>
#include "test_dsp_analysis.h"
#include "dsp_analysis.h"

#define NSAMPLES  (512)

int test_dsp() {

  // RUN TESTCODE ON PYTHON GENERATED WAVEFORM:
  int16_t* fft_mag;
  uint16_t samples_in[NSAMPLES] = {
   31451,  55117,  43820,  39065,  47856,  42185,  42141,  47361,
   31151,  28632,  55938,  58883,  39349,  39342,  38821,  28165,
   31648,  26786,   9005,  23336,  48198,  38203,  27589,  35280,
   30999,  28158,  35445,  22836,  15690,  42388,  53072,  34547,
   31869,  34191,  23229,  24181,  22284,   2560,   9318,  35809,
   29901,  15183,  21507,  19902,  15381,  24488,  17504,   8354,
   34764,  55289,  42345,  39875,  47998,  41447,  42972,  46739,
   29439,  30516,  58010,  57182,  38329,  39939,  37835,  27805,
   32172,  25039,   8539,  26279,  48784,  36358,  27941,  35652,
   30113,  28837,  35336,  21012,  17066,  45026,  51924,  33188,
   32532,  33471,  22534,  24782,  20784,   1391,  11898,  36974,
   27971,  15081,  22136,  19046,  15897,  24946,  15873,   9328,
   38008,  55085,  41021,  40806,  47948,  40817,  43849,  45853,
   27921,  32707,  59757,  55295,  37566,  40475,  36745,  27637,
   32563,  23155,   8458,  29276,  48971,  34586,  28483,  35844,
   29282,  29630,  34970,  19286,  18810,  47422,  50497,  32064,
   33201,  32595,  22015,  25320,  19078,    554,  14647,  37747,
   26019,  15219,  22620,  18187,  16580,  25184,  14245,  10705,
   41118,  54533,  39884,  41815,  47711,  40323,  44732,  44715,
   26650,  35157,  61142,  53277,  37060,  40910,  35583,  27656,
   32786,  21181,   8779,  32258,  48772,  32936,  29179,  35849,
   28543,  30502,  34343,  17715,  20890,  49523,  48842,  31190,
   33832,  31589,  21680,  25752,  17203,     82,  17498,  38121,
   24103,  15574,  22940,  17363,  17403,  25182,  12677,  12471,
   44031,  53672,  38966,  42860,  47301,  39988,  45578,  43344,
   25674,  37810,  62139,  51187,  36801,  41216,  34387,  27851,
   32807,  19170,   9509,  35159,  48207,  31452,  29992,  35667,
   27925,  31414,  33458,  16356,  23266,  51288,  47012,  30572,
   34388,  30484,  21533,  26040,  15200,      0,  20385,  38099,
   22276,  16113,  23082,  16609,  18337,  24927,  11227,  14603,
   46691,  52546,  38287,  43898,  46740,  39827,  46344,  41770,
   25031,  40606,  62733,  49084,  36769,  41365,  33193,  28204,
   32602,  17179,  10642,  37913,  47310,  30171,  30878,  35308,
   27456,  32325,  32329,  15258,  25887,  52682,  45065,  30205,
   34832,  29314,  21568,  26146,  13119,    322,  23240,  37696,
   20587,  16802,  23041,  15960,  19347,  24416,   9954,  17066,
   49048,  51208,  37862,  44887,  46052,  39847,  46987,  40030,
   24753,  43479,  62919,  47023,  36940,  41340,  32041,  28689,
   32153,  15265,  12163,  40458,  46120,  29121,  31794,  34786,
   27154,  33191,  30976,  14468,  28697,  53682,  43061,  30078,
   35135,  28115,  21772,  26041,  11014,   1051,  25996,  36938,
   19077,  17599,  22821,  15446,  20392,  23656,   8911,  19816,
   51062,  49713,  37692,  45788,  45271,  40049,  47469,  38167,
   24862,  46362,  62705,  45058,  37280,  41131,  30965,  29274,
   31449,  13487,  14044,  42740,  44684,  28321,  32698,  34125,
   27034,  33970,  29433,  14022,  31632,  54275,  41056,  30170,
   35273,  26926,  22124,  25701,   8942,   2179,  28588,  35859,
   17781,  18462,  22431,  15092,  21430,  22662,   8149,  22802,
   52700,  48118,  37771,  46567,  44430,  40426,  47754,  36233,
   25368,  49186,  62108,  43235,  37752,  40734,  30000,  29922,
   30490,  11901,  16249,  44713,  43056,  27781,  33547,  33352,
   27102,  34619,  27737,  13949,  34627,  54461,  39107,  30452,
   35230,  25784,  22597,  25110,   6961,   3689,  30957,  34500,
   16725,  19348,  21889,  14916,  22418,  21459,   7709,  25964,
   53944,  46483,  38086,  47196,  43568,  40961,  47815,  34283,
   26273,  51886,  61156,  41594,  38316,  40155,  29173,  30594,
   29286,  10562,  18731,  46337,  41290,  27502,  34306,  32499,
   27355,  35101,  25934,  14269,  37614,  54249,  37264,  30892,
   34998,  24725,  23157,  24262,   5129,   5549,  33050,  32912,
   15927,  20214,  21220,  14930,  23312,  20080,   7627,  29238,
   54782,  44863,  38611,  47654,  42722,  41632,  47629,  32372,
   27566,  54397,  59885,  40168,  38928,  39406,  28509,  31246,
   27854,   9518,  21437,  47584,  39447,  27475,  34940,  31602,
   27783,  35383,  24077,  14989,  40524,  53660,  35572,  31451};

  fft_mag = dsp_fft_mag(samples_in, NSAMPLES);
  // PRINT OUTPUT FOR PLOTTING IN PYTHON:
  printf("%3s , %10s , %5s\r\n", "idx","mag","freq");
  for (int i=0; i<NSAMPLES/2; i++) {
    printf("%3d , %10d , %5d\r\n", i, fft_mag[i], i*48000/NSAMPLES);
  } 

  // following results were calculated with python
  fft_peaks results = {
      {0,   3,   5,   9,  11,  19,  21, 107},
      {3,   0,   0,   0,  28,   0,  26,  31}
  };


  uint32_t bucket_indices[] = {0,2,4,6,10,15,20,30,255};

   fft_peaks test_res_peak;
  dsp_find_peaks(fft_mag, &test_res_peak, bucket_indices);

  for (int i=0; i<NBUCKETS; i++) {
    assert(results.mags[i] == test_res_peak.mags[i]);
    assert(results.indices[i] == test_res_peak.indices[i]);
  }

  return 1;
}
