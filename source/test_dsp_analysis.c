/* -----------------------------------------------------------------------------
 * test_dsp_analysis.c 
 *
 * @author  Jake Michael
 * @date    
 * @rev    
 * -----------------------------------------------------------------------------
 */

#include <stdio.h>
#include <stdint.h>
#include <assert.h>
#include "test_dsp_analysis.h"
#include "dsp_analysis.h"

#define NSAMPLES  (256)

int test_dsp() {

  // RUN TESTCODE ON PYTHON GENERATED WAVEFORM:
  int16_t* fft_mag;
  uint16_t samples_in[NSAMPLES] = {
   31297,  54970,  43602,  38958,  47721,  41950,  42087,  47133,
   30699,  28807,  56242,  58357,  38915,  39354,  38391,  27878,
   31681,  26029,   8632,  24341,  48338,  37233,  27571,  35327,
   30395,  28343,  35263,  21643,  16296,  43860,  52233,  33487,
   32156,  33557,  22564,  24471,  21021,   1474,  11199,  36635,
   28135,  14926,  21913,  18979,  15696,  24771,  15782,   9154,
   37867,  54921,  40810,  40717,  47781,  40602,  43810,  45543,
   27531,  33005,  59930,  54678,  37259,  40452,  36252,  27469,
   32505,  22299,   8378,  30324,  48779,  33683,  28635,  35716,
   28741,  29927,  34505,  18216,  19844,  48588,  49321,  31311,
   33479,  31755,  21603,  25497,  17518,      0,  16765,  37929,
   24250,  15359,  22758,  17286,  17182,  25034,  12575,  12292,
   43899,  53489,  38772,  42780,  47102,  39807,  45532,  42960,
   25382,  38195,  62149,  50532,  36618,  41120,  33872,  27794,
   32610,  18287,   9744,  36142,  47710,  30698,  30246,  35359,
   27512,  31746,  32710,  15538,  24641,  52036,  45631,  30149,
   34549,  29518,  21387,  25984,  13468,     63,  22528,  37640,
   20685,  16548,  22901,  15861,  19118,  24295,   9835,  16888,
   48920,  51008,  37692,  44803,  45827,  39707,  46910,  39588,
   24590,  43903,  62752,  46383,  36860,  41146,  31549,  28716,
   31784,  14439,  12698,  41273,  45376,  28574,  32071,  34322,
   26915,  33467,  29986,  14013,  30285,  53943,  41622,  29961,
   35094,  27123,  21859,  25658,   9270,   1751,  27948,  35912,
   17809,  18193,  22328,  14963,  21206,  22560,   8011,  22632,
   52569,  47905,  37629,  46468,  44191,  40328,  47623,  35763,
   25351,  49595,  61770,  42659,  37741,  40432,  29575,  29989,
   29942,  11219,  17038,  45274,  42149,  27468,  33768,  32782,
   27056,  34748,  26584,  13932,  36274,  54221,  37752,  30575,
   34938,  24872,  22843,  24346,   5383,   4976,  32523,  33040,
   15874,  19953,  21142,  14767,  23105,  19989,   7471,  29080,
   54641,  44645,  38496,  47529,  42483,  41570,  47427,  31909,
   27695,  54736,  59400,  39694,  38942,  39004,  28184,  31297};

  fft_mag = dsp_fft_mag(samples_in, NSAMPLES);
  // PRINT OUTPUT FOR PLOTTING IN PYTHON:
  printf("%3s , %10s , %5s\r\n", "idx","mag","freq");
  for (int i=0; i<NSAMPLES/2; i++) {
    printf("%3d , %10d , %5d\r\n", i, fft_mag[i], i*48000/NSAMPLES);
  } 

  // following results were calculated with python
  fft_peaks results = {
      {11,  27,  47,  54,  79,  80, 111, 127},
      {28,  29,   0,  24,   2,  27,   0,   0}
  };

  fft_peaks test_res_peak;
  dsp_find_peaks(fft_mag, &test_res_peak);

  for (int i=0; i<8; i++) {
    assert(results.mags[i] == test_res_peak.mags[i]);
    assert(results.indices[i] == test_res_peak.indices[i]);
  }

  return 1;
}
